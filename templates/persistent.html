<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ¤– Persistent Bluesky Bot</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;padding:24px;color:#1f2937
    }
    .container{
      max-width:960px;margin:0 auto;background:#fff;backdrop-filter:blur(4px);
      border-radius:18px;padding:28px;box-shadow:0 18px 40px rgba(0,0,0,.12)
    }
    h1{font-size:26px;margin-bottom:8px;color:#111827}
    .sub{color:#6b7280;margin-bottom:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{
      border:1px solid #e5e7eb;border-radius:14px;padding:18px;background:#fafafa
    }
    .card h3{font-size:16px;margin-bottom:10px;color:#4338ca}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type="text"],input[type="password"],input[type="number"],textarea,select{
      width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;
      font-size:14px;background:#fff
    }
    textarea{min-height:62px;resize:vertical}
    .muted{color:#6b7280;font-size:12px;margin-top:4px}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{
      border:0;border-radius:10px;padding:10px 14px;font-weight:700;color:#fff;cursor:pointer
    }
    .primary{background:#10b981}
    .danger{background:#ef4444}
    .warn{background:#f59e0b}
    .info{background:#3b82f6}
    .status{
      background:#ecfeff;border:1px solid #22d3ee;color:#155e75;
      padding:12px;border-radius:12px;margin:10px 0;font-weight:600
    }
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .kv div{
      background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:10px
    }
    .kv small{display:block;color:#6b7280;font-size:12px;margin-bottom:4px}
    .footer-note{color:#6b7280;font-size:12px;margin-top:10px}
    @media (max-width:800px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¤– Persistent Bluesky Bot</h1>
    <p class="sub">ÙŠØ´ØºÙ‘Ù„ Ø§Ù„Ø±Ø¯ÙˆØ¯/Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø´Ø± Ø¨Ø´ÙƒÙ„ Ù…ØªØªØ§Ø¨Ø¹ Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù… ÙÙŠ /data</p>

    <div id="flash" class="status" style="display:none;"></div>

    <div class="grid">
      <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
      <div class="card">
        <h3>Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
        <label for="bluesky_handle">Ø§Ù„Ø­Ø³Ø§Ø¨ (Handle)</label>
        <input id="bluesky_handle" type="text" placeholder="user.bsky.social" />
        <label for="bluesky_password" style="margin-top:10px;">ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (App Password)</label>
        <input id="bluesky_password" type="password" placeholder="xxxx-xxxx-xxxx-xxxx" />
        <p class="muted">âš ï¸ Ø§Ø³ØªØ®Ø¯Ù…ÙŠ App Password Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Bluesky ÙˆÙ„ÙŠØ³ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©.</p>
      </div>

      <!-- Ø§Ù„Ø±ÙˆØ§Ø¨Ø· -->
      <div class="card">
        <h3>Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</h3>
        <label for="post_urls">Ø¶Ø¹ÙŠ Ø±Ø§Ø¨Ø· Ù…Ù†Ø´ÙˆØ± Ø£Ùˆ Ø£ÙƒØ«Ø± (ÙƒÙ„ Ø³Ø·Ø± Ø±Ø§Ø¨Ø·):</label>
        <textarea id="post_urls" placeholder="https://bsky.app/profile/USER/post/POSTID"></textarea>
        <p class="muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ«Ø± Ù…Ù† Ø±Ø§Ø¨Ø·â€”Ø³Ø·Ø± Ù„ÙƒÙ„ Ø±Ø§Ø¨Ø·. Ø³ÙŠØ¹Ø§Ù„Ø¬Ù‡Ø§ Ø§Ù„Ø¨ÙˆØª Ø¨Ø§Ù„ØªØ³Ù„Ø³Ù„.</p>
      </div>

      <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
      <div class="card">
        <h3>Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (2â€“10 Ø±Ø³Ø§Ø¦Ù„)</h3>
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
          <textarea id="msg1" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 1"></textarea>
          <textarea id="msg2" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 2"></textarea>
          <textarea id="msg3" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 3 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
          <textarea id="msg4" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 4 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
          <textarea id="msg5" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 5 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
          <textarea id="msg6" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 6 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
          <textarea id="msg7" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 7 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
          <textarea id="msg8" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 8 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
          <textarea id="msg9" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 9 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
          <textarea id="msg10" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 10 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
        </div>
        <p class="muted">Ø³ÙŠØ®ØªØ§Ø± Ø§Ù„Ø¨ÙˆØª Ø±Ø³Ø§Ù„Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ÙƒÙ„ Ø±Ø¯.</p>
      </div>

      <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
      <div class="card">
        <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
        <label for="processing_type">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</label>
        <select id="processing_type">
          <option value="replies">Ø§Ù„Ø±Ø¯ÙˆØ¯ ÙÙ‚Ø· (Replies)</option>
          <option value="reposts">Ø¥Ø¹Ø§Ø¯Ø© Ù†Ø´Ø± ÙÙ‚Ø· (Reposts)</option>
          <option value="both">Ø±Ø¯ÙˆØ¯ + Ø¥Ø¹Ø§Ø¯Ø© Ù†Ø´Ø±</option>
        </select>

        <div class="grid" style="margin-top:10px;gap:10px">
          <div>
            <label for="min_delay">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªØ£Ø®ÙŠØ± (Ø«ÙˆØ§Ù†Ù)</label>
            <input id="min_delay" type="number" value="180" />
          </div>
          <div>
            <label for="max_delay">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØªØ£Ø®ÙŠØ± (Ø«ÙˆØ§Ù†Ù)</label>
            <input id="max_delay" type="number" value="300" />
          </div>
        </div>

        <div class="btns" style="margin-top:14px">
          <button class="primary" onclick="queueTask()">âœ… Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
          <button class="danger" onclick="stopTask()">ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù</button>
          <button class="warn" onclick="resumeTask()">â–¶ï¸ Ø§Ø³ØªØ¦Ù†Ø§Ù</button>
          <button class="info" onclick="refreshStatus()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</button>
        </div>
        <p class="footer-note">ÙŠØ­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ <code>/data/progress.json</code> Ù„ÙƒÙ„ Ø­Ø³Ø§Ø¨/Ø±Ø§Ø¨Ø·.</p>
      </div>
    </div>

    <!-- Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© -->
    <div class="card" style="margin-top:16px">
      <h3>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</h3>
      <div class="kv">
        <div><small>Ø§Ù„Ø­Ø§Ù„Ø©</small><b id="runStatus">Idle</b></div>
        <div><small>Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</small><b id="currentTask">â€”</b></div>
        <div><small>Ø²Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©</small><b id="sessionUptime">0s</b></div>
        <div><small>Ù…Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­</small><b id="successRate">0%</b></div>
        <div><small>Ù…Ù†Ø¬Ø²</small><b id="completedRuns">0</b></div>
        <div><small>ÙØ´Ù„</small><b id="failedRuns">0</b></div>
        <div><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</small><b id="totalRuns">0</b></div>
        <div><small>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</small><b id="lastUpdated">â€”</b></div>
      </div>
    </div>
  </div>

  <script>
    function flash(msg, ok=true){
      const el = document.getElementById('flash');
      el.textContent = msg;
      el.style.display = 'block';
      el.style.background = ok ? '#ecfeff' : '#fee2e2';
      el.style.borderColor = ok ? '#22d3ee' : '#ef4444';
      el.style.color = ok ? '#155e75' : '#7f1d1d';
      setTimeout(()=>{ el.style.display='none'; }, 4500);
    }

    function getMessageTemplates(){
      const ids = ['msg1','msg2','msg3','msg4','msg5','msg6','msg7','msg8','msg9','msg10'];
      const out = [];
      ids.forEach(id=>{
        const v = (document.getElementById(id).value || '').trim();
        if(v) out.push(v);
      });
      return out;
    }

    function getPostUrls(){
      const raw = (document.getElementById('post_urls').value || '').trim();
      if(!raw) return [];
      // ÙƒÙ„ Ø³Ø·Ø± Ø±Ø§Ø¨Ø·
      return raw.split('\n').map(s=>s.trim()).filter(Boolean);
    }

    async function queueTask(){
      const bluesky_handle = document.getElementById('bluesky_handle').value.trim();
      const bluesky_password = document.getElementById('bluesky_password').value.trim();
      const post_urls = getPostUrls();
      const message_templates = getMessageTemplates();
      const processing_type = document.getElementById('processing_type').value;
      const min_delay = parseInt(document.getElementById('min_delay').value || '180', 10);
      const max_delay = parseInt(document.getElementById('max_delay').value || '300', 10);

      if(!bluesky_handle || !bluesky_password || post_urls.length===0){
        flash('âŒ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆÙˆØ¶Ø¹ Ø±Ø§Ø¨Ø·/Ø±ÙˆØ§Ø¨Ø· Ù…Ù†Ø´ÙˆØ±.', false);
        return;
      }

      try{
        const res = await fetch('/queue_task', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            bluesky_handle, bluesky_password,
            post_urls, message_templates,
            processing_type, min_delay, max_delay
          })
        });
        const data = await res.json();
        if(res.ok){
          flash('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØ¨Ø¯Ø£ Ø§Ù„ØªÙ†ÙÙŠØ°.');
          refreshStatus();
        }else{
          flash(data.error || 'âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©.', false);
        }
      }catch(e){
        flash('âŒ Ø®Ø·Ø£ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©.', false);
      }
    }

    async function stopTask(){
      try{
        const res = await fetch('/stop_task');
        const data = await res.json();
        flash(data.status || 'ğŸ›‘ ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù');
        refreshStatus();
      }catch(e){
        flash('âŒ ÙØ´Ù„ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ù‡Ù…Ø©.', false);
      }
    }

    async function resumeTask(){
      try{
        const res = await fetch('/resume_task');
        const data = await res.json();
        flash(data.status || 'â–¶ï¸ ØªÙ… Ø§Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù');
        refreshStatus();
      }catch(e){
        flash('âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù.', false);
      }
    }

    async function refreshStatus(){
      try{
        const res = await fetch('/detailed_progress');
        const data = await res.json();
        const rs = data.runtime_stats || {};
        const bp = data.bot_progress || {};

        document.getElementById('runStatus').textContent = rs.status || 'Idle';
        document.getElementById('currentTask').textContent = rs.current_task || 'â€”';
        document.getElementById('sessionUptime').textContent = rs.session_uptime || '0s';

        const completed = bp.completed_runs || 0;
        const failed = bp.failed_runs || 0;
        const total = bp.total_bot_runs || (completed + failed);
        const rate = total ? ((completed/total)*100).toFixed(2)+'%' : '0%';

        document.getElementById('completedRuns').textContent = completed;
        document.getElementById('failedRuns').textContent = failed;
        document.getElementById('totalRuns').textContent = total;
        document.getElementById('successRate').textContent = rate;

        document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
      }catch(e){
        document.getElementById('runStatus').textContent = 'âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
    setInterval(refreshStatus, 5000);
    window.onload = refreshStatus;
  </script>
</body>
  </html>
