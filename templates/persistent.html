<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>🤖 Persistent Bluesky Bot</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;padding:24px;color:#1f2937
    }
    .container{
      max-width:960px;margin:0 auto;background:#fff;backdrop-filter:blur(4px);
      border-radius:18px;padding:28px;box-shadow:0 18px 40px rgba(0,0,0,.12)
    }
    h1{font-size:26px;margin-bottom:8px;color:#111827}
    .sub{color:#6b7280;margin-bottom:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{
      border:1px solid #e5e7eb;border-radius:14px;padding:18px;background:#fafafa
    }
    .card h3{font-size:16px;margin-bottom:10px;color:#4338ca}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type="text"],input[type="password"],input[type="number"],textarea,select{
      width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;
      font-size:14px;background:#fff
    }
    textarea{min-height:62px;resize:vertical}
    .muted{color:#6b7280;font-size:12px;margin-top:4px}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{
      border:0;border-radius:10px;padding:10px 14px;font-weight:700;color:#fff;cursor:pointer
    }
    .primary{background:#10b981}
    .danger{background:#ef4444}
    .warn{background:#f59e0b}
    .info{background:#3b82f6}
    .status{
      background:#ecfeff;border:1px solid #22d3ee;color:#155e75;
      padding:12px;border-radius:12px;margin:10px 0;font-weight:600
    }
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .kv div{
      background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:10px
    }
    .kv small{display:block;color:#6b7280;font-size:12px;margin-bottom:4px}
    .footer-note{color:#6b7280;font-size:12px;margin-top:10px}
    @media (max-width:800px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1>🤖 Persistent Bluesky Bot</h1>
    <p class="sub">يشغّل الردود/إعادة النشر بشكل متتابع مع حفظ التقدّم في /data</p>

    <div id="flash" class="status" style="display:none;"></div>

    <div class="grid">
      <!-- بيانات الدخول -->
      <div class="card">
        <h3>بيانات تسجيل الدخول</h3>
        <label for="bluesky_handle">الحساب (Handle)</label>
        <input id="bluesky_handle" type="text" placeholder="user.bsky.social" />
        <label for="bluesky_password" style="margin-top:10px;">كلمة مرور التطبيق (App Password)</label>
        <input id="bluesky_password" type="password" placeholder="xxxx-xxxx-xxxx-xxxx" />
        <p class="muted">⚠️ استخدمي App Password من إعدادات Bluesky وليس كلمة المرور العادية.</p>
      </div>

      <!-- الروابط -->
      <div class="card">
        <h3>روابط المنشورات</h3>
        <label for="post_urls">ضعي رابط منشور أو أكثر (كل سطر رابط):</label>
        <textarea id="post_urls" placeholder="https://bsky.app/profile/USER/post/POSTID"></textarea>
        <p class="muted">يمكنك إضافة أكثر من رابط—سطر لكل رابط. سيعالجها البوت بالتسلسل.</p>
      </div>

      <!-- الرسائل -->
      <div class="card">
        <h3>قوالب الرسائل (2–10 رسائل)</h3>
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
          <textarea id="msg1" placeholder="الرسالة 1"></textarea>
          <textarea id="msg2" placeholder="الرسالة 2"></textarea>
          <textarea id="msg3" placeholder="الرسالة 3 (اختياري)"></textarea>
          <textarea id="msg4" placeholder="الرسالة 4 (اختياري)"></textarea>
          <textarea id="msg5" placeholder="الرسالة 5 (اختياري)"></textarea>
          <textarea id="msg6" placeholder="الرسالة 6 (اختياري)"></textarea>
          <textarea id="msg7" placeholder="الرسالة 7 (اختياري)"></textarea>
          <textarea id="msg8" placeholder="الرسالة 8 (اختياري)"></textarea>
          <textarea id="msg9" placeholder="الرسالة 9 (اختياري)"></textarea>
          <textarea id="msg10" placeholder="الرسالة 10 (اختياري)"></textarea>
        </div>
        <p class="muted">سيختار البوت رسالة عشوائية من القائمة لكل رد.</p>
      </div>

      <!-- الإعدادات -->
      <div class="card">
        <h3>الإعدادات</h3>
        <label for="processing_type">نوع المعالجة</label>
        <select id="processing_type">
          <option value="replies">الردود فقط (Replies)</option>
          <option value="reposts">إعادة نشر فقط (Reposts)</option>
          <option value="both">ردود + إعادة نشر</option>
        </select>

        <div class="grid" style="margin-top:10px;gap:10px">
          <div>
            <label for="min_delay">الحد الأدنى للتأخير (ثوانٍ)</label>
            <input id="min_delay" type="number" value="180" />
          </div>
          <div>
            <label for="max_delay">الحد الأقصى للتأخير (ثوانٍ)</label>
            <input id="max_delay" type="number" value="300" />
          </div>
        </div>

        <div class="btns" style="margin-top:14px">
          <button class="primary" onclick="queueTask()">✅ بدء المهمة</button>
          <button class="danger" onclick="stopTask()">🛑 إيقاف</button>
          <button class="warn" onclick="resumeTask()">▶️ استئناف</button>
          <button class="info" onclick="refreshStatus()">🔄 تحديث الحالة</button>
        </div>
        <p class="footer-note">يحفظ التقدّم تلقائيًا في <code>/data/progress.json</code> لكل حساب/رابط.</p>
      </div>
    </div>

    <!-- الحالة العامة -->
    <div class="card" style="margin-top:16px">
      <h3>حالة التشغيل</h3>
      <div class="kv">
        <div><small>الحالة</small><b id="runStatus">Idle</b></div>
        <div><small>المهمة الحالية</small><b id="currentTask">—</b></div>
        <div><small>زمن الجلسة</small><b id="sessionUptime">0s</b></div>
        <div><small>معدّل النجاح</small><b id="successRate">0%</b></div>
        <div><small>منجز</small><b id="completedRuns">0</b></div>
        <div><small>فشل</small><b id="failedRuns">0</b></div>
        <div><small>إجمالي المحاولات</small><b id="totalRuns">0</b></div>
        <div><small>آخر تحديث</small><b id="lastUpdated">—</b></div>
      </div>
    </div>
  </div>

  <script>
    function flash(msg, ok=true){
      const el = document.getElementById('flash');
      el.textContent = msg;
      el.style.display = 'block';
      el.style.background = ok ? '#ecfeff' : '#fee2e2';
      el.style.borderColor = ok ? '#22d3ee' : '#ef4444';
      el.style.color = ok ? '#155e75' : '#7f1d1d';
      setTimeout(()=>{ el.style.display='none'; }, 4500);
    }

    function getMessageTemplates(){
      const ids = ['msg1','msg2','msg3','msg4','msg5','msg6','msg7','msg8','msg9','msg10'];
      const out = [];
      ids.forEach(id=>{
        const v = (document.getElementById(id).value || '').trim();
        if(v) out.push(v);
      });
      return out;
    }

    function getPostUrls(){
      const raw = (document.getElementById('post_urls').value || '').trim();
      if(!raw) return [];
      // كل سطر رابط
      return raw.split('\n').map(s=>s.trim()).filter(Boolean);
    }

    async function queueTask(){
      const bluesky_handle = document.getElementById('bluesky_handle').value.trim();
      const bluesky_password = document.getElementById('bluesky_password').value.trim();
      const post_urls = getPostUrls();
      const message_templates = getMessageTemplates();
      const processing_type = document.getElementById('processing_type').value;
      const min_delay = parseInt(document.getElementById('min_delay').value || '180', 10);
      const max_delay = parseInt(document.getElementById('max_delay').value || '300', 10);

      if(!bluesky_handle || !bluesky_password || post_urls.length===0){
        flash('❌ يرجى تعبئة الحساب وكلمة المرور ووضع رابط/روابط منشور.', false);
        return;
      }

      try{
        const res = await fetch('/queue_task', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            bluesky_handle, bluesky_password,
            post_urls, message_templates,
            processing_type, min_delay, max_delay
          })
        });
        const data = await res.json();
        if(res.ok){
          flash('✅ تم إرسال المهمة وبدأ التنفيذ.');
          refreshStatus();
        }else{
          flash(data.error || '❌ فشل إرسال المهمة.', false);
        }
      }catch(e){
        flash('❌ خطأ بالشبكة أثناء إرسال المهمة.', false);
      }
    }

    async function stopTask(){
      try{
        const res = await fetch('/stop_task');
        const data = await res.json();
        flash(data.status || '🛑 تم الإيقاف');
        refreshStatus();
      }catch(e){
        flash('❌ فشل إيقاف المهمة.', false);
      }
    }

    async function resumeTask(){
      try{
        const res = await fetch('/resume_task');
        const data = await res.json();
        flash(data.status || '▶️ تم الاستئناف');
        refreshStatus();
      }catch(e){
        flash('❌ فشل الاستئناف.', false);
      }
    }

    async function refreshStatus(){
      try{
        const res = await fetch('/detailed_progress');
        const data = await res.json();
        const rs = data.runtime_stats || {};
        const bp = data.bot_progress || {};

        document.getElementById('runStatus').textContent = rs.status || 'Idle';
        document.getElementById('currentTask').textContent = rs.current_task || '—';
        document.getElementById('sessionUptime').textContent = rs.session_uptime || '0s';

        const completed = bp.completed_runs || 0;
        const failed = bp.failed_runs || 0;
        const total = bp.total_bot_runs || (completed + failed);
        const rate = total ? ((completed/total)*100).toFixed(2)+'%' : '0%';

        document.getElementById('completedRuns').textContent = completed;
        document.getElementById('failedRuns').textContent = failed;
        document.getElementById('totalRuns').textContent = total;
        document.getElementById('successRate').textContent = rate;

        document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
      }catch(e){
        document.getElementById('runStatus').textContent = '❌ فشل التحميل';
      }
    }

    // تحديث دوري كل 5 ثوانٍ
    setInterval(refreshStatus, 5000);
    window.onload = refreshStatus;
  </script>
</body>
  </html>
