<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Persistent Bluesky Bot</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:#f5f7ff;margin:0;color:#222}
    .wrap{max-width:900px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.08);padding:22px;margin:18px 0}
    h1{font-size:40px;margin:8px 0 0;text-align:center}
    .note{background:#e7f6ff;border:1px dashed #7cc4ff;padding:16px;border-radius:12px;margin-top:14px;color:#044d6b}
    label.label{display:block;margin:8px 0 6px;font-weight:600}
    input,textarea,select{width:100%;box-sizing:border-box;border:1px solid #d7dbee;border-radius:10px;padding:10px 12px;font-size:16px;background:#fff}
    textarea{min-height:90px;resize:vertical;white-space:pre-wrap}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .btn{border:0;border-radius:12px;padding:12px 14px;font-size:16px;cursor:pointer}
    .btn-primary{background:#28c76f;color:#fff}
    .btn-warn{background:#ff5252;color:#fff}
    .btn-ghost{background:#eef3ff}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .kpi .box{background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.06);padding:14px}
    .box h4{margin:0 0 6px;font-size:14px;color:#666}
    .box .big{font-size:22px;font-weight:700}
    .section-title{font-size:20px;margin:10px 0 6px}
    small.muted{color:#6b7280}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Persistent Bluesky Bot 🤖</h1>
    <div class="note">
      تنويه: اضغطي «بدء المهمة» بعد إدخال البيانات. ينصح باستخدام
      <b>App Password</b> من إعدادات Bluesky وليس كلمة المرور العادية.
    </div>

    <!-- بيانات الدخول + الروابط + الرسائل -->
    <div class="card">
      <h3 class="section-title">بيانات تسجيل الدخول</h3>
      <div class="grid">
        <div>
          <label class="label">حساب بلوسكاي</label>
          <input id="bluesky_handle" placeholder="example.bsky.social" />
        </div>
        <div>
          <label class="label">كلمة المرور (App Password)</label>
          <input id="bluesky_password" type="password" placeholder="xxxx-xxxx-xxxx-xxxx" />
        </div>
      </div>

      <h3 class="section-title">روابط المنشورات المستهدفة</h3>
      <textarea id="post_urls" placeholder="ضعي كل رابط بسطر مستقل"></textarea>

      <h3 class="section-title">قائمة الرسائل (سيتم اختيار رسالة عشوائية لكل رد)</h3>
      <div class="grid-3">
        <textarea class="msg" placeholder="الرسالة 1"></textarea>
        <textarea class="msg" placeholder="الرسالة 2"></textarea>
        <textarea class="msg" placeholder="الرسالة 3"></textarea>
        <textarea class="msg" placeholder="الرسالة 4"></textarea>
        <textarea class="msg" placeholder="الرسالة 5"></textarea>
        <textarea class="msg" placeholder="الرسالة 6"></textarea>
        <textarea class="msg" placeholder="الرسالة 7"></textarea>
        <textarea class="msg" placeholder="الرسالة 8"></textarea>
        <textarea class="msg" placeholder="الرسالة 9"></textarea>
      </div>
      <small class="muted">اتركي أي خانة لا تحتاجينها فارغة.</small>
    </div>

    <!-- الإعدادات -->
    <div class="card">
      <h3 class="section-title">الإعدادات</h3>

      <label class="label">مصدر الجمهور</label>
      <select id="audience_type">
        <option value="likers">المعجبون بالمنشور (Likers)</option>
        <option value="reposters">معيدو النشر (Reposters)</option>
        <option value="both">المعجبون + معيدو النشر</option>
      </select>

      <div class="grid" style="margin-top:10px">
        <div>
          <label class="label">الحد الأدنى للتأخير (ثوان)</label>
          <input id="min_delay" placeholder="مثال 180" value="180" />
        </div>
        <div>
          <label class="label">الحد الأقصى للتأخير (ثوان)</label>
          <input id="max_delay" placeholder="مثال 300" value="300" />
        </div>
      </div>

      <div class="row" style="margin-top:14px">
        <button class="btn btn-warn" onclick="stopTask()">إيقاف</button>
        <button class="btn btn-primary" onclick="startTask()">بدء المهمة ✅</button>
        <button class="btn btn-ghost" onclick="refreshStatus()">تحديث الحالة 🔄</button>
      </div>

      <div style="margin-top:8px">
        <small class="muted">سيحفظ التقدم تلقائيًا في: <code id="progress_path">{{ progress_path or 'data/progress.json' }}</code></small>
      </div>
    </div>

    <!-- حالة التشغيل -->
    <div class="card">
      <h3 class="section-title">حالة التشغيل</h3>
      <div class="kpi">
        <div class="box">
          <h4>الحالة</h4>
          <div class="big" id="k_status">Idle</div>
        </div>
        <div class="box">
          <h4>المهمة الحالية</h4>
          <div class="big" id="k_task">—</div>
        </div>
        <div class="box">
          <h4>منجز</h4>
          <div class="big" id="k_done">0</div>
        </div>
        <div class="box">
          <h4>فشل</h4>
          <div class="big" id="k_fail">0</div>
        </div>
        <div class="box">
          <h4>معدل النجاح</h4>
          <div class="big" id="k_rate">0%</div>
        </div>
        <div class="box">
          <h4>زمن الجلسة</h4>
          <div class="big" id="k_uptime">0s</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function startTask() {
      const handle = document.getElementById('bluesky_handle').value.trim();
      const password = document.getElementById('bluesky_password').value.trim();
      const min_delay = document.getElementById('min_delay').value.trim();
      const max_delay = document.getElementById('max_delay').value.trim();
      const audience_type = document.getElementById('audience_type').value;

      const urls_raw = document.getElementById('post_urls').value.trim();
      const post_urls = urls_raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

      const msg_nodes = document.querySelectorAll('.msg');
      const message_templates = Array.from(msg_nodes).map(n => n.value.trim()).filter(Boolean);

      const payload = {
        bluesky_handle: handle,
        bluesky_password: password,
        post_urls,
        message_templates,
        min_delay: parseInt(min_delay) || 180,
        max_delay: parseInt(max_delay) || 300,
        audience_type // likers | reposters | both
      };

      try {
        const res = await fetch('/queue_task', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        alert(data.status || data.error || 'تم الإرسال');
        refreshStatus();
      } catch (e) {
        alert('خطأ في الإرسال: ' + e);
      }
    }

    async function stopTask() {
      try {
        const res = await fetch('/stop_task', {method: 'POST'});
        const data = await res.json();
        alert(data.status || 'تمت العملية');
        refreshStatus();
      } catch (e) {
        alert('خطأ: ' + e);
      }
    }

    async function refreshStatus() {
      try {
        const res = await fetch('/detailed_progress');
        const data = await res.json();

        const rt = data.runtime_stats || {};
        const bp = data.bot_progress || {};

        document.getElementById('k_status').textContent = rt.status || 'Idle';
        document.getElementById('k_task').textContent = rt.current_task || '—';
        document.getElementById('k_uptime').textContent = rt.session_uptime || '0s';

        document.getElementById('k_done').textContent = bp.completed_runs ?? 0;
        document.getElementById('k_fail').textContent = bp.failed_runs ?? 0;
        const rate = bp.success_rate ? (bp.success_rate * 100).toFixed(2) + '%' : '0%';
        document.getElementById('k_rate').textContent = rate;
      } catch (e) {
        console.error(e);
      }
    }

    // تحديث فوري عند فتح الصفحة
    refreshStatus();
  </script>
</body>
</html>
