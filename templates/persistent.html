<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Persistent Bluesky Bot</title>
  <style>
    body{font-family:system-ui,Segoe UI,Tahoma,Arial;background:#f6f7fb;margin:0}
    .wrap{max-width:900px;margin:24px auto;padding:16px}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:18px;margin-bottom:18px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:14px;color:#333;margin:8px 0;display:block}
    input,select,textarea{width:100%;box-sizing:border-box;padding:10px 12px;border:1px solid #ddd;border-radius:10px;background:#fafafa}
    textarea{min-height:140px;white-space:pre-wrap}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .success{background:#00c853;color:#fff}
    .danger{background:#ff5252;color:#fff}
    .primary{background:#2979ff;color:#fff}
    .muted{background:#eceff1}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .kpi{background:#fff;border:1px dashed #e0e0e0;border-radius:10px;padding:12px;text-align:center}
    .kpi h3{margin:2px 0 8px;font-size:14px;color:#666}
    .kpi div{font-size:18px;font-weight:700}
    .hint{font-size:13px;color:#555;margin-top:8px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <h2>Persistent Bluesky Bot</h2>
    <p>يعمل بشكل مستمر بالخلفية. استخدم <b>App Password</b> من إعدادات Bluesky.</p>
  </div>

  <div class="card">
    <form id="form">
      <div class="row">
        <div>
          <label>يوزر Bluesky</label>
          <input name="handle" placeholder="example.bsky.social"/>
        </div>
        <div>
          <label>App Password</label>
          <input name="password" placeholder="xxxx-xxxx-xxxx-xxxx"/>
        </div>
      </div>

      <label>رابط البوست (سيجلب منه الجمهور حسب نوع المعالجة)</label>
      <input name="post_url" placeholder="https://bsky.app/profile/.../post/..."/>

      <div class="row">
        <div>
          <label>نوع المعالجة</label>
          <select name="mode">
            <option value="likes">المعجبون فقط (Likes)</option>
            <option value="reposts">معيدو النشر فقط (Reposts)</option>
          </select>
        </div>
        <div></div>
      </div>

      <div class="row">
        <div>
          <label>الحد الأدنى للتأخير (ثوان)</label>
          <input name="min_delay" value="200"/>
        </div>
        <div>
          <label>الحد الأقصى للتأخير (ثوان)</label>
          <input name="max_delay" value="250"/>
        </div>
      </div>

      <label>الرسائل (سطر لكل رسالة، سيختار عشوائيًا لكل مستخدم)</label>
      <textarea name="messages" placeholder="Message 1&#10;Message 2&#10;Message 3"></textarea>

      <div class="btns" style="margin-top:10px">
        <button type="button" class="success" onclick="start()">بدء المهمة ✅</button>
        <button type="button" class="danger" onclick="stop()">إيقاف ⛔</button>
        <button type="button" class="primary" onclick="resume()">استئناف ▶️</button>
        <button type="button" class="muted" onclick="refresh()">تحديث الحالة 🔄</button>
      </div>
      <div class="hint">يحفظ التقدم تلقائيًا في ملف <span class="mono">{{ progress_path }}</span>.</div>
    </form>
  </div>

  <div class="card">
    <h3>حالة التشغيل</h3>
    <div id="status">
      <div>الحالة الحالية: <b id="running">—</b></div>
      <div class="hint">ملخص التقدم لكل مفتاح (يوزر|رابط|نوع):</div>
      <pre class="mono" id="progress" style="white-space:pre-wrap;background:#f8f8f8;border-radius:8px;padding:10px;overflow:auto;max-height:300px"></pre>
    </div>
  </div>

</div>

<script>
async function call(url, data){
  const resp = await fetch(url, {method:'POST', body: new FormData(document.getElementById('form'))});
  return resp.json();
}
async function start(){ const r = await call('/start'); alert(r.ok? 'بدأت المهمة' : ('خطأ: '+r.msg)); refresh(); }
async function stop(){ const r = await call('/stop'); alert('تم إيقاف المهمة'); refresh(); }
async function resume(){ const r = await call('/resume'); alert(r.ok? 'استئناف' : ('خطأ: '+r.msg)); refresh(); }
async function refresh(){
  const r = await fetch('/status').then(r=>r.json());
  document.getElementById('running').textContent = r.running ? 'Running' : 'Idle';
  document.getElementById('progress').textContent = JSON.stringify(r.progress, null, 2);
}
refresh();
</script>
</body>
</html>
