<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Persistent Bluesky Bot</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:#f5f7ff;margin:0;color:#222}
    .wrap{max-width:900px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.08);padding:22px;margin:18px 0}
    h1{font-size:40px;margin:8px 0 0;text-align:center}
    .note{background:#e7f6ff;border:1px dashed #7cc4ff;padding:16px;border-radius:12px;margin-top:14px;color:#044d6b}
    label.label{display:block;margin:8px 0 6px;font-weight:600}
    input,textarea,select{width:100%;box-sizing:border-box;border:1px solid #d7dbee;border-radius:10px;padding:10px 12px;font-size:16px;background:#fff}
    textarea{min-height:90px;resize:vertical;white-space:pre-wrap}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .btn{border:0;border-radius:12px;padding:12px 14px;font-size:16px;cursor:pointer}
    .btn-primary{background:#28c76f;color:#fff}
    .btn-warn{background:#ff5252;color:#fff}
    .btn-ghost{background:#eef3ff}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .kpi .box{background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.06);padding:14px}
    .box h4{margin:0 0 6px;font-size:14px;color:#666}
    .box .big{font-size:22px;font-weight:700}
    .section-title{font-size:20px;margin:10px 0 6px}
    small.muted{color:#6b7280}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Persistent Bluesky Bot ğŸ¤–</h1>
    <div class="note">
      ØªÙ†ÙˆÙŠÙ‡: Ø§Ø¶ØºØ·ÙŠ Â«Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©Â» Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠÙ†ØµØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…
      <b>App Password</b> Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Bluesky ÙˆÙ„ÙŠØ³ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©.
    </div>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ + Ø§Ù„Ø±ÙˆØ§Ø¨Ø· + Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
    <div class="card">
      <h3 class="section-title">Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      <div class="grid">
        <div>
          <label class="label">Ø­Ø³Ø§Ø¨ Ø¨Ù„ÙˆØ³ÙƒØ§ÙŠ</label>
          <input id="bluesky_handle" placeholder="example.bsky.social" />
        </div>
        <div>
          <label class="label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (App Password)</label>
          <input id="bluesky_password" type="password" placeholder="xxxx-xxxx-xxxx-xxxx" />
        </div>
      </div>

      <h3 class="section-title">Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</h3>
      <textarea id="post_urls" placeholder="Ø¶Ø¹ÙŠ ÙƒÙ„ Ø±Ø§Ø¨Ø· Ø¨Ø³Ø·Ø± Ù…Ø³ØªÙ‚Ù„"></textarea>

      <h3 class="section-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø³ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø±Ø³Ø§Ù„Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù„ÙƒÙ„ Ø±Ø¯)</h3>
      <div class="grid-3">
        <textarea class="msg" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 1"></textarea>
        <textarea class="msg" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 2"></textarea>
        <textarea class="msg" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 3"></textarea>
        <textarea class="msg" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 4"></textarea>
        <textarea class="msg" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 5"></textarea>
        <textarea class="msg" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 6"></textarea>
        <textarea class="msg" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 7"></textarea>
        <textarea class="msg" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 8"></textarea>
        <textarea class="msg" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø© 9"></textarea>
      </div>
      <small class="muted">Ø§ØªØ±ÙƒÙŠ Ø£ÙŠ Ø®Ø§Ù†Ø© Ù„Ø§ ØªØ­ØªØ§Ø¬ÙŠÙ†Ù‡Ø§ ÙØ§Ø±ØºØ©.</small>
    </div>

    <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <div class="card">
      <h3 class="section-title">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>

      <label class="label">Ù…ØµØ¯Ø± Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±</label>
      <select id="audience_type">
        <option value="likers">Ø§Ù„Ù…Ø¹Ø¬Ø¨ÙˆÙ† Ø¨Ø§Ù„Ù…Ù†Ø´ÙˆØ± (Likers)</option>
        <option value="reposters">Ù…Ø¹ÙŠØ¯Ùˆ Ø§Ù„Ù†Ø´Ø± (Reposters)</option>
        <option value="both">Ø§Ù„Ù…Ø¹Ø¬Ø¨ÙˆÙ† + Ù…Ø¹ÙŠØ¯Ùˆ Ø§Ù„Ù†Ø´Ø±</option>
      </select>

      <div class="grid" style="margin-top:10px">
        <div>
          <label class="label">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªØ£Ø®ÙŠØ± (Ø«ÙˆØ§Ù†)</label>
          <input id="min_delay" placeholder="Ù…Ø«Ø§Ù„ 180" value="180" />
        </div>
        <div>
          <label class="label">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØªØ£Ø®ÙŠØ± (Ø«ÙˆØ§Ù†)</label>
          <input id="max_delay" placeholder="Ù…Ø«Ø§Ù„ 300" value="300" />
        </div>
      </div>

      <div class="row" style="margin-top:14px">
        <button class="btn btn-warn" onclick="stopTask()">Ø¥ÙŠÙ‚Ø§Ù</button>
        <button class="btn btn-primary" onclick="startTask()">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© âœ…</button>
        <button class="btn btn-ghost" onclick="refreshStatus()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ğŸ”„</button>
      </div>

      <div style="margin-top:8px">
        <small class="muted">Ø³ÙŠØ­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ: <code id="progress_path">{{ progress_path or 'data/progress.json' }}</code></small>
      </div>
    </div>

    <!-- Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ -->
    <div class="card">
      <h3 class="section-title">Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</h3>
      <div class="kpi">
        <div class="box">
          <h4>Ø§Ù„Ø­Ø§Ù„Ø©</h4>
          <div class="big" id="k_status">Idle</div>
        </div>
        <div class="box">
          <h4>Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
          <div class="big" id="k_task">â€”</div>
        </div>
        <div class="box">
          <h4>Ù…Ù†Ø¬Ø²</h4>
          <div class="big" id="k_done">0</div>
        </div>
        <div class="box">
          <h4>ÙØ´Ù„</h4>
          <div class="big" id="k_fail">0</div>
        </div>
        <div class="box">
          <h4>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­</h4>
          <div class="big" id="k_rate">0%</div>
        </div>
        <div class="box">
          <h4>Ø²Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©</h4>
          <div class="big" id="k_uptime">0s</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function startTask() {
      const handle = document.getElementById('bluesky_handle').value.trim();
      const password = document.getElementById('bluesky_password').value.trim();
      const min_delay = document.getElementById('min_delay').value.trim();
      const max_delay = document.getElementById('max_delay').value.trim();
      const audience_type = document.getElementById('audience_type').value;

      const urls_raw = document.getElementById('post_urls').value.trim();
      const post_urls = urls_raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

      const msg_nodes = document.querySelectorAll('.msg');
      const message_templates = Array.from(msg_nodes).map(n => n.value.trim()).filter(Boolean);

      const payload = {
        bluesky_handle: handle,
        bluesky_password: password,
        post_urls,
        message_templates,
        min_delay: parseInt(min_delay) || 180,
        max_delay: parseInt(max_delay) || 300,
        audience_type // likers | reposters | both
      };

      try {
        const res = await fetch('/queue_task', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        alert(data.status || data.error || 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
        refreshStatus();
      } catch (e) {
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + e);
      }
    }

    async function stopTask() {
      try {
        const res = await fetch('/stop_task', {method: 'POST'});
        const data = await res.json();
        alert(data.status || 'ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
        refreshStatus();
      } catch (e) {
        alert('Ø®Ø·Ø£: ' + e);
      }
    }

    async function refreshStatus() {
      try {
        const res = await fetch('/detailed_progress');
        const data = await res.json();

        const rt = data.runtime_stats || {};
        const bp = data.bot_progress || {};

        document.getElementById('k_status').textContent = rt.status || 'Idle';
        document.getElementById('k_task').textContent = rt.current_task || 'â€”';
        document.getElementById('k_uptime').textContent = rt.session_uptime || '0s';

        document.getElementById('k_done').textContent = bp.completed_runs ?? 0;
        document.getElementById('k_fail').textContent = bp.failed_runs ?? 0;
        const rate = bp.success_rate ? (bp.success_rate * 100).toFixed(2) + '%' : '0%';
        document.getElementById('k_rate').textContent = rate;
      } catch (e) {
        console.error(e);
      }
    }

    // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    refreshStatus();
  </script>
</body>
</html>
