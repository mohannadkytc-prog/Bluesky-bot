<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Persistent Bluesky Bot</title>
<style>
  body {font-family: system-ui, Tahoma; background:#f3f6ff; color:#222; margin:0; padding:0;}
  .wrap {max-width: 900px; margin: 24px auto; padding: 0 16px;}
  .card {background:#fff; border-radius:14px; padding:18px 16px; margin:14px 0; box-shadow:0 8px 24px rgba(0,0,0,.06);}
  h1{font-size:32px; margin:0 0 8px;}
  input, select, textarea {width:100%; border:1px solid #ddd; border-radius:12px; padding:10px 12px; margin:8px 0 14px; font-size:16px;}
  textarea{min-height:100px}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .btn{display:inline-block; padding:10px 14px; border-radius:12px; border:0; cursor:pointer; font-size:16px}
  .btn-primary{background:#2563eb; color:#fff}
  .btn-warn{background:#ef4444; color:#fff}
  .btn-ghost{background:#f1f5f9}
  .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
  .stat{background:#fafafa;border:1px solid #eee;border-radius:12px;padding:12px;text-align:center}
  .muted{color:#667}
  .note{background:#e0f2fe; padding:10px 12px; border-radius:10px; border:1px solid #bae6fd}
</style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <h1>Persistent Bluesky Bot 🤖</h1>
    <p class="muted">يعمل بالخلفية حتى بعد إغلاق الصفحة. يُنصح باستخدام <b>App Password</b> من إعدادات Bluesky.</p>
  </div>

  <div class="card">
    <h3>بيانات الدخول</h3>
    <div class="row">
      <div>
        <label>حساب بلوسكاي (handle)</label>
        <input id="handle" placeholder="example.bsky.social" />
      </div>
      <div>
        <label>كلمة مرور التطبيق</label>
        <input id="password" type="password" placeholder="App Password" />
      </div>
    </div>

    <h3>هدف المهمة</h3>
    <label>رابط البوست المستهدف</label>
    <input id="post_url" placeholder="https://bsky.app/profile/xxx/post/xxxx" />

    <label>نوع المعالجة</label>
    <select id="processing_mode">
      <option value="LIKES">معجبون (Likes)</option>
      <option value="REPOSTS">معيدو نشر (Reposts)</option>
    </select>

    <div class="row">
      <div>
        <label>الحد الأدنى للتأخير (ثواني)</label>
        <input id="min_delay" type="number" value="200" />
      </div>
      <div>
        <label>الحد الأقصى للتأخير (ثواني)</label>
        <input id="max_delay" type="number" value="250" />
      </div>
    </div>

    <label>الرسائل (سطر لكل رسالة، سيُختار عشوائيًا لكل مستخدم)</label>
    <textarea id="messages" placeholder="Message 1\nMessage 2\nMessage 3"></textarea>

    <div>
      <button class="btn btn-primary" onclick="startTask()">بدء المهمة ✅</button>
      <button class="btn btn-warn" onclick="stopTask()">إيقاف ⛔</button>
      <button class="btn btn-ghost" onclick="refresh()">تحديث الحالة 🔄</button>
    </div>
    <p class="note">يُحفظ التقدم تلقائيًا في ملف progress.json حسب الحساب/الرابط.</p>
  </div>

  <div class="card">
    <h3>حالة التشغيل</h3>
    <div class="grid">
      <div class="stat">
        <div class="muted">الحالة</div>
        <div id="st">—</div>
      </div>
      <div class="stat">
        <div class="muted">المهمة الحالية</div>
        <div id="task">—</div>
      </div>
      <div class="stat">
        <div class="muted">إجمالي الجمهور</div>
        <div id="total">0</div>
      </div>
      <div class="stat">
        <div class="muted">تم إنجازه</div>
        <div id="done">0</div>
      </div>
      <div class="stat">
        <div class="muted">فشل</div>
        <div id="failed">0</div>
      </div>
      <div class="stat">
        <div class="muted">نسبة النجاح</div>
        <div id="rate">0%</div>
      </div>
    </div>
  </div>

</div>

<script>
async function startTask(){
  const payload = {
    bluesky_handle: document.getElementById('handle').value.trim(),
    bluesky_password: document.getElementById('password').value.trim(),
    post_url: document.getElementById('post_url').value.trim(),
    processing_mode: document.getElementById('processing_mode').value,
    min_delay: parseInt(document.getElementById('min_delay').value || '200'),
    max_delay: parseInt(document.getElementById('max_delay').value || '250'),
    messages: (document.getElementById('messages').value || '')
                .split('\n').map(s => s.trim()).filter(Boolean),
  };
  const r = await fetch('/queue_task', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  const j = await r.json();
  alert(JSON.stringify(j));
  refresh();
}

async function stopTask(){
  await fetch('/stop_task', {method:'POST'});
  refresh();
}

async function refresh(){
  const r = await fetch('/detailed_progress');
  const j = await r.json();
  document.getElementById('st').innerText = j.runtime_stats.status;
  document.getElementById('task').innerText = j.runtime_stats.current_task || '—';
  document.getElementById('total').innerText = j.bot_progress.total;
  document.getElementById('done').innerText = j.bot_progress.done;
  document.getElementById('failed').innerText = j.bot_progress.failed;
  document.getElementById('rate').innerText = ((j.bot_progress.success_rate*100)||0).toFixed(2)+'%';
}
refresh();
</script>
</body>
</html>
