<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Persistent Bluesky Bot</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root{--bg:#f5f7fb;--card:#fff;--text:#1f2937;--muted:#6b7280;--accent:#6366f1;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444;--soft:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto;color:var(--text)}
    .wrap{max-width:920px;margin:32px auto;padding:0 16px}
    h1{font-size:34px;margin:0 0 8px}
    p.mono{font-size:13px;color:var(--muted)}
    .card{background:var(--card);border-radius:16px;box-shadow:0 8px 20px rgba(17,24,39,.08);padding:20px;margin:18px 0}
    label{display:block;font-weight:700;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:12px 14px;border:1px solid var(--soft);border-radius:12px;font-size:15px;background:#fff}
    textarea{min-height:140px;white-space:pre}
    .grid{display:grid;gap:14px}
    .g2{grid-template-columns:1fr 1fr}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .ok{background:var(--ok);color:#fff}
    .bad{background:var(--bad);color:#fff}
    .muted{background:#e9eefb;color:#1f2d5c}
    .warn{background:var(--warn);color:#fff}
    .pill{display:inline-block;padding:.25rem .6rem;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:700;font-size:12px}
    .stat{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .kpi{background:#fff;border:1px solid var(--soft);border-radius:14px;padding:14px;text-align:center}
    .kpi h3{margin:2px 0 6px;font-size:14px;color:var(--muted)}
    .kpi div{font-size:22px;font-weight:800}
    small.hint{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Persistent Bluesky Bot <span class="pill">Replies on users’ latest posts</span></h1>
    <p class="mono">يعمل بالخلفية ويستأنف تلقائياً. رجاءً استخدمي <b>App Password</b> من إعدادات Bluesky.</p>

    <div class="card">
      <h2>بيانات الدخول</h2>
      <div class="grid g2">
        <div>
          <label>حساب بلوسكاي (handle)</label>
          <input id="handle" placeholder="example.bsky.social"/>
        </div>
        <div>
          <label>كلمة المرور (App Password)</label>
          <input id="password" type="password" placeholder="xxxx-xxxx-xxxx-xxxx"/>
        </div>
      </div>
      <div style="height:8px"></div>
      <label>رابط البوست (لجلب الجمهور)</label>
      <input id="post_url" placeholder="https://bsky.app/profile/USER/post/XXXX"/>
    </div>

    <div class="card">
      <h2>الرسائل</h2>
      <label>سطر لكل رسالة (سيُختار عشوائياً لكل مستخدم)</label>
      <textarea id="messages" placeholder="رسالة 1&#10;رسالة 2&#10;رسالة 3"></textarea>
      <small class="hint">سطر لكل رسالة. الحد 280 حرفاً.</small>
    </div>

    <div class="card">
      <h2>الإعدادات</h2>
      <div class="grid g2">
        <div>
          <label>نوع المعالجة</label>
          <select id="processing_type">
            <option value="likers">المعجبون (likers)</option>
            <option value="reposters">معيدو النشر (reposters)</option>
          </select>
        </div>
        <div></div>
        <div>
          <label>الحد الأدنى للتأخير (ثواني)</label>
          <input id="min_delay" type="number" min="0" value="{{ default_min }}"/>
        </div>
        <div>
          <label>الحد الأقصى للتأخير (ثواني)</label>
          <input id="max_delay" type="number" min="0" value="{{ default_max }}"/>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="row">
        <button class="btn ok" onclick="queue()">✅ بدء المهمة</button>
        <button class="btn bad" onclick="stop()">⛔ إيقاف</button>
        <button class="btn muted" onclick="refresh()">🔄 تحديث الحالة</button>
      </div>
      <div style="height:10px"></div>
      <div class="mono">يحفظ التقدم تلقائياً في ملف <b>progress.json</b> حسب الحساب/الرابط.</div>
    </div>

    <div class="card">
      <h2>حالة التشغيل</h2>
      <div class="stat">
        <div class="kpi">
          <h3>الحالة</h3>
          <div id="st_status">Idle</div>
        </div>
        <div class="kpi">
          <h3>المهمة الحالية</h3>
          <div id="st_task">—</div>
        </div>
        <div class="kpi">
          <h3>تم إنجازه</h3>
          <div id="st_done">0</div>
        </div>
        <div class="kpi">
          <h3>فشل</h3>
          <div id="st_fail">0</div>
        </div>
        <div class="kpi">
          <h3>إجمالي الجمهور</h3>
          <div id="st_total">0</div>
        </div>
        <div class="kpi">
          <h3>نسبة النجاح</h3>
          <div id="st_rate">0%</div>
        </div>
      </div>
    </div>
  </div>

<script>
async function queue(){
  const handle = document.getElementById('handle').value.trim();
  const password = document.getElementById('password').value.trim();
  const post_url = document.getElementById('post_url').value.trim();

  const messagesRaw = document.getElementById('messages').value || '';
  const messages = messagesRaw.split('\n').map(s => s.trim()).filter(Boolean);

  const min_delay = parseInt(document.getElementById('min_delay').value || '200');
  const max_delay = parseInt(document.getElementById('max_delay').value || '250');
  const processing_type = document.getElementById('processing_type').value;

  const payload = {
    bluesky_handle: handle,
    bluesky_password: password,
    post_url,
    messages,
    processing_type,    // 'likers' | 'reposters'
    min_delay,
    max_delay
  };

  const r = await fetch('/queue_task', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const j = await r.json();
  alert((j.status || j.error || 'تم الإرسال'));
  refresh();
}

async function stop(){
  await fetch('/stop_task', {method:'POST'});
  refresh();
}

async function refresh(){
  const r = await fetch('/detailed_progress');
  const j = await r.json();

  const rs = j.runtime_stats || {};
  const bp = j.bot_progress || {};

  document.getElementById('st_status').innerText = rs.status || '—';
  document.getElementById('st_task').innerText = rs.current_task || '—';
  document.getElementById('st_done').innerText = bp.completed_runs || 0;
  document.getElementById('st_fail').innerText = bp.failed_runs || 0;
  document.getElementById('st_total').innerText = bp.audience_total || 0;

  const rate = (bp.success_rate || 0) * 100;
  document.getElementById('st_rate').innerText = `${rate.toFixed(2)}%`;
}
refresh();
</script>
</body>
</html>
