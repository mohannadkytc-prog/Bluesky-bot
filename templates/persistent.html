<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Persistent Bluesky Bot</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root{--bg:#f5f7fb;--card:#fff;--text:#1f2937;--muted:#6b7280;--accent:#6366f1;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444;--soft:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto;color:var(--text)}
    .wrap{max-width:920px;margin:32px auto;padding:0 16px}
    h1{font-size:34px;margin:0 0 8px}
    p.mono{font-size:13px;color:var(--muted)}
    .card{background:var(--card);border-radius:16px;box-shadow:0 8px 20px rgba(17,24,39,.08);padding:20px;margin:18px 0}
    label{display:block;font-weight:700;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:12px 14px;border:1px solid var(--soft);border-radius:12px;font-size:15px;background:#fff}
    textarea{min-height:140px;white-space:pre}
    .grid{display:grid;gap:14px}
    .g2{grid-template-columns:1fr 1fr}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .ok{background:var(--ok);color:#fff}
    .bad{background:var(--bad);color:#fff}
    .muted{background:#e9eefb;color:#1f2d5c}
    .warn{background:var(--warn);color:#fff}
    .pill{display:inline-block;padding:.25rem .6rem;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:700;font-size:12px}
    .stat{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .kpi{background:#fff;border:1px solid var(--soft);border-radius:14px;padding:14px;text-align:center}
    .kpi h3{margin:2px 0 6px;font-size:14px;color:var(--muted)}
    .kpi div{font-size:22px;font-weight:800}
    small.hint{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Persistent Bluesky Bot <span class="pill">Replies on usersâ€™ latest posts</span></h1>
    <p class="mono">ÙŠØ¹Ù…Ù„ Ø¨Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆÙŠØ³ØªØ£Ù†Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø³ØªØ®Ø¯Ù…ÙŠ <b>App Password</b> Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Bluesky.</p>

    <div class="card">
      <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <div class="grid g2">
        <div>
          <label>Ø­Ø³Ø§Ø¨ Ø¨Ù„ÙˆØ³ÙƒØ§ÙŠ (handle)</label>
          <input id="handle" placeholder="example.bsky.social"/>
        </div>
        <div>
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (App Password)</label>
          <input id="password" type="password" placeholder="xxxx-xxxx-xxxx-xxxx"/>
        </div>
      </div>
      <div style="height:8px"></div>
      <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨ÙˆØ³Øª (Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±)</label>
      <input id="post_url" placeholder="https://bsky.app/profile/USER/post/XXXX"/>
    </div>

    <div class="card">
      <h2>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h2>
      <label>Ø³Ø·Ø± Ù„ÙƒÙ„ Ø±Ø³Ø§Ù„Ø© (Ø³ÙŠÙØ®ØªØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹ Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…)</label>
      <textarea id="messages" placeholder="Ø±Ø³Ø§Ù„Ø© 1&#10;Ø±Ø³Ø§Ù„Ø© 2&#10;Ø±Ø³Ø§Ù„Ø© 3"></textarea>
      <small class="hint">Ø³Ø·Ø± Ù„ÙƒÙ„ Ø±Ø³Ø§Ù„Ø©. Ø§Ù„Ø­Ø¯ 280 Ø­Ø±ÙØ§Ù‹.</small>
    </div>

    <div class="card">
      <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
      <div class="grid g2">
        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</label>
          <select id="processing_type">
            <option value="likers">Ø§Ù„Ù…Ø¹Ø¬Ø¨ÙˆÙ† (likers)</option>
            <option value="reposters">Ù…Ø¹ÙŠØ¯Ùˆ Ø§Ù„Ù†Ø´Ø± (reposters)</option>
          </select>
        </div>
        <div></div>
        <div>
          <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªØ£Ø®ÙŠØ± (Ø«ÙˆØ§Ù†ÙŠ)</label>
          <input id="min_delay" type="number" min="0" value="{{ default_min }}"/>
        </div>
        <div>
          <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØªØ£Ø®ÙŠØ± (Ø«ÙˆØ§Ù†ÙŠ)</label>
          <input id="max_delay" type="number" min="0" value="{{ default_max }}"/>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="row">
        <button class="btn ok" onclick="queue()">âœ… Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
        <button class="btn bad" onclick="stop()">â›” Ø¥ÙŠÙ‚Ø§Ù</button>
        <button class="btn muted" onclick="refresh()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</button>
      </div>
      <div style="height:10px"></div>
      <div class="mono">ÙŠØ­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ù…Ù„Ù <b>progress.json</b> Ø­Ø³Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨/Ø§Ù„Ø±Ø§Ø¨Ø·.</div>
    </div>

    <div class="card">
      <h2>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</h2>
      <div class="stat">
        <div class="kpi">
          <h3>Ø§Ù„Ø­Ø§Ù„Ø©</h3>
          <div id="st_status">Idle</div>
        </div>
        <div class="kpi">
          <h3>Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
          <div id="st_task">â€”</div>
        </div>
        <div class="kpi">
          <h3>ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡</h3>
          <div id="st_done">0</div>
        </div>
        <div class="kpi">
          <h3>ÙØ´Ù„</h3>
          <div id="st_fail">0</div>
        </div>
        <div class="kpi">
          <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±</h3>
          <div id="st_total">0</div>
        </div>
        <div class="kpi">
          <h3>Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</h3>
          <div id="st_rate">0%</div>
        </div>
      </div>
    </div>
  </div>

<script>
async function queue(){
  const handle = document.getElementById('handle').value.trim();
  const password = document.getElementById('password').value.trim();
  const post_url = document.getElementById('post_url').value.trim();

  const messagesRaw = document.getElementById('messages').value || '';
  const messages = messagesRaw.split('\n').map(s => s.trim()).filter(Boolean);

  const min_delay = parseInt(document.getElementById('min_delay').value || '200');
  const max_delay = parseInt(document.getElementById('max_delay').value || '250');
  const processing_type = document.getElementById('processing_type').value;

  const payload = {
    bluesky_handle: handle,
    bluesky_password: password,
    post_url,
    messages,
    processing_type,    // 'likers' | 'reposters'
    min_delay,
    max_delay
  };

  const r = await fetch('/queue_task', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const j = await r.json();
  alert((j.status || j.error || 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'));
  refresh();
}

async function stop(){
  await fetch('/stop_task', {method:'POST'});
  refresh();
}

async function refresh(){
  const r = await fetch('/detailed_progress');
  const j = await r.json();

  const rs = j.runtime_stats || {};
  const bp = j.bot_progress || {};

  document.getElementById('st_status').innerText = rs.status || 'â€”';
  document.getElementById('st_task').innerText = rs.current_task || 'â€”';
  document.getElementById('st_done').innerText = bp.completed_runs || 0;
  document.getElementById('st_fail').innerText = bp.failed_runs || 0;
  document.getElementById('st_total').innerText = bp.audience_total || 0;

  const rate = (bp.success_rate || 0) * 100;
  document.getElementById('st_rate').innerText = `${rate.toFixed(2)}%`;
}
refresh();
</script>
</body>
</html>
