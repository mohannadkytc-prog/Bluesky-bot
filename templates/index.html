<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bluesky Bot Control</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:#f6f7fb;color:#222;margin:0;padding:24px}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:18px;margin-bottom:18px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 260px}
    label{display:block;margin-bottom:6px;font-weight:600}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #d9dbe3;border-radius:10px;background:#fdfdff}
    textarea{min-height:140px;white-space:pre}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:10px;border:0;font-weight:600;cursor:pointer}
    .btn-start{background:#12b886;color:#fff}
    .btn-stop{background:#fa5252;color:#fff}
    .btn-res{background:#228be6;color:#fff}
    .btn-refresh{background:#7950f2;color:#fff}
    .kpi{display:grid;grid-template-columns:repeat(3,minmax(160px,1fr));gap:10px}
    .kpi .box{background:#fff;border-radius:12px;border:1px solid #e9ebf3;padding:14px;text-align:center}
    .muted{color:#6b7280}
    code{background:#f1f3f5;padding:2px 6px;border-radius:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;white-space:pre-wrap}
  </style>
</head>
<body>

  <h2>لوحة تحكم بوت Bluesky</h2>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>حساب Bluesky (handle)</label>
        <input id="handle" placeholder="user.bsky.social">
      </div>
      <div class="col">
        <label>كلمة المرور</label>
        <input id="password" type="password" placeholder="******">
      </div>
      <div class="col">
        <label>رابط المنشور (لجلب الجمهور)</label>
        <input id="link" placeholder="https://bsky.app/profile/.../post/...">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>نوع المعالجة</label>
        <select id="processing_type">
          <option value="likers">المعجبون (Likers)</option>
          <option value="reposters">معيدو النشر (Reposters)</option>
        </select>
      </div>
      <div class="col">
        <label>الحد الأدنى للتأخير (ثوان)</label>
        <input id="min_delay" value="{{ default_min_delay }}">
      </div>
      <div class="col">
        <label>الحد الأقصى للتأخير (ثوان)</label>
        <input id="max_delay" value="{{ default_max_delay }}">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>الرسائل (سطر لكل رسالة، سيختار عشوائياً لكل مستخدم)</label>
        <textarea id="messages"></textarea>
      </div>
    </div>

    <div class="row" style="gap:8px">
      <button class="btn btn-start" onclick="startTask()">✔️ بدء المهمة</button>
      <button class="btn btn-stop" onclick="stopTask()">⛔ إيقاف</button>
      <button class="btn btn-res" onclick="resumeTask()">▶️ استئناف</button>
      <button class="btn btn-refresh" onclick="refreshStatus()">🔄 تحديث الحالة</button>
    </div>

    <p class="muted">يحفظ التقدم تلقائياً لكل حساب/رابط في ملف <code>{{ data_dir }}/progress.json</code>.</p>
  </div>

  <div class="card">
    <h3>حالة التشغيل</h3>
    <div class="kpi">
      <div class="box">
        <div class="muted">الحالة</div>
        <div id="st_running">Idle</div>
      </div>
      <div class="box">
        <div class="muted">إجمالي الجمهور</div>
        <div id="st_total">0</div>
      </div>
      <div class="box">
        <div class="muted">منجز</div>
        <div id="st_done">0</div>
      </div>
      <div class="box">
        <div class="muted">فشل</div>
        <div id="st_fail">0</div>
      </div>
      <div class="box">
        <div class="muted">آخر خطأ</div>
        <div id="st_error">—</div>
      </div>
      <div class="box">
        <div class="muted">مهمة</div>
        <div id="st_task" class="mono">—</div>
      </div>
    </div>

    <h4>ملخص لكل مستخدم</h4>
    <pre id="st_summary" class="mono" style="background:#fff;border:1px solid #eee;border-radius:10px;padding:12px;max-height:280px;overflow:auto">—</pre>
  </div>

<script>
async function startTask(){
  const payload = {
    handle: document.getElementById('handle').value,
    password: document.getElementById('password').value,
    link: document.getElementById('link').value,
    processing_type: document.getElementById('processing_type').value,
    min_delay: document.getElementById('min_delay').value,
    max_delay: document.getElementById('max_delay').value,
    messages: document.getElementById('messages').value
  };
  const r = await fetch('/start', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  const j = await r.json();
  if(!j.ok) alert(j.error||'Error');
  refreshStatus();
}
async function stopTask(){
  const r = await fetch('/stop', {method:'POST'});
  await r.json();
  refreshStatus();
}
async function resumeTask(){
  const body = {
    // خُذ نفس النص من مربع الرسائل
    messages: document.getElementById('messages').value
  };
  const r = await fetch('/resume', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  const j = await r.json();
  alert(j.msg || j.error || 'ok');
  refreshStatus();
}
async function refreshStatus(){
  const r = await fetch('/status');
  const j = await r.json();
  if(!j.ok) return;
  const st = j.state;
  document.getElementById('st_running').innerText = st.running ? (st.paused ? 'Paused' : 'Running') : 'Idle';
  document.getElementById('st_total').innerText = st.stats.total;
  document.getElementById('st_done').innerText = st.stats.done;
  document.getElementById('st_fail').innerText = st.stats.fail;
  document.getElementById('st_error').innerText = st.stats.last_error || '—';
  document.getElementById('st_task').innerText = st.current_task || '—';
  document.getElementById('st_summary').innerText = JSON.stringify(st.summary, null, 2) || '—';
}
setInterval(refreshStatus, 4000);
</script>

</body>
</html>
