from flask import Flask, request, jsonify, render_template_string
from bluesky_bot import start_task, stop_task, resume_task, read_status
from utils import validate_message_template

app = Flask(__name__)

HTML = """
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bluesky Bot Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<style>
 body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Tahoma,Arial; background:#f5f7fb; color:#222; padding:20px}
 .card{background:#fff;border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.06); padding:20px; margin:16px auto; max-width:960px}
 h1{margin:0 0 8px}
 label{display:block;margin:12px 0 6px;font-weight:600}
 input[type=text],input[type=password],textarea,select{
   width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; background:#fafafa}
 textarea{min-height:140px}
 .grid{display:grid; gap:16px}
 @media(min-width:768px){ .grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:1fr 1fr 1fr}}
 .btn{display:inline-flex; align-items:center; gap:8px; padding:12px 16px;
   border:0; border-radius:12px; cursor:pointer; font-weight:700}
 .btn-primary{background:#16a34a;color:#fff} .btn-danger{background:#ef4444;color:#fff}
 .btn-info{background:#0ea5e9;color:#fff} .btn-warning{background:#f59e0b;color:#111}
 .stats{display:grid; gap:12px; grid-template-columns:repeat(3,1fr)}
 .stat{background:#fafafa; border:1px dashed #e5e7eb; padding:12px; border-radius:12px; text-align:center}
 .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas}
 small{color:#777}
</style>
</head>
<body>

<div class="card">
  <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø¨ÙˆØª Bluesky</h1>
  <small>Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙˆØ§Ø³ØªØ¦Ù†Ø§ÙÙ‡ Ù„ÙƒÙ„ (Ø­Ø³Ø§Ø¨/ÙˆØ¶Ø¹/Ø±Ø§Ø¨Ø·).</small>
  <form id="f" onsubmit="return false;">
    <div class="grid grid-2">
      <div>
        <label>Ø­Ø³Ø§Ø¨ Bluesky (handle)</label>
        <input type="text" name="handle" placeholder="username.bsky.social" required>
      </div>
      <div>
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="password" name="password" required>
      </div>
      <div>
        <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¬Ù„Ø¨ Ø¬Ù…Ù‡ÙˆØ±Ù‡</label>
        <input type="text" name="post_url" placeholder="https://bsky.app/profile/.../post/..." required>
      </div>
      <div>
        <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</label>
        <select name="mode">
          <option value="likers">Ø§Ù„Ù…Ø¹Ø¬Ø¨ÙˆÙ† (Likes)</option>
          <option value="reposters">Ù…Ø¹ÙŠØ¯Ùˆ Ø§Ù„Ù†Ø´Ø± (Reposts)</option>
        </select>
      </div>
    </div>

    <div class="grid grid-2">
      <div>
        <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªØ£Ø®ÙŠØ± (Ø«ÙˆØ§Ù†)</label>
        <input type="text" name="min_delay" value="200">
      </div>
      <div>
        <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØªØ£Ø®ÙŠØ± (Ø«ÙˆØ§Ù†)</label>
        <input type="text" name="max_delay" value="250">
      </div>
    </div>

    <label>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø³Ø·Ø± Ù„ÙƒÙ„ Ø±Ø³Ø§Ù„Ø© â€” Ø³ÙŠØ®ØªØ§Ø± Ø§Ù„Ø¨ÙˆØª Ø³Ø·Ø±Ù‹Ø§ Ø¹Ø´ÙˆØ§Ø¦ÙŠÙ‹Ø§ Ù„ÙƒÙ„ Ø±Ø¯)</label>
    <textarea name="messages" placeholder="Ø³Ø·Ø± Ù„ÙƒÙ„ Ø±Ø³Ø§Ù„Ø©..."></textarea>

    <div style="margin-top:12px">
      <button class="btn btn-primary" onclick="start()">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© âœ…</button>
      <button class="btn btn-danger" onclick="stop()">Ø¥ÙŠÙ‚Ø§Ù â›”</button>
      <button class="btn btn-info" onclick="resume()">Ø§Ø³ØªØ¦Ù†Ø§Ù â–¶ï¸</button>
      <button class="btn btn-warning" onclick="refresh()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ğŸ”„</button>
      <small class="mono" id="datadir"></small>
    </div>
  </form>
</div>

<div class="card">
  <h2>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</h2>
  <div class="stats">
    <div class="stat">
      <div>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
      <div class="mono" id="st"></div>
    </div>
    <div class="stat">
      <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±</div>
      <div class="mono" id="total">0</div>
    </div>
    <div class="stat">
      <div>Ø§Ù„Ù…Ù†Ø¬Ø²</div>
      <div class="mono" id="ok">0</div>
    </div>
  </div>

  <div class="stats" style="margin-top:12px">
    <div class="stat">
      <div>ÙØ´Ù„</div>
      <div class="mono" id="fail">0</div>
    </div>
    <div class="stat">
      <div>Ù…ØªØ¨Ù‚Ù‘ÙŠ</div>
      <div class="mono" id="rem">0</div>
    </div>
    <div class="stat">
      <div>Ø§Ù„Ù…ÙØ¹Ø§Ù„Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠ (DID)</div>
      <div class="mono" id="curr">â€”</div>
    </div>
  </div>

  <div style="margin-top:16px">
    <label>Ø¢Ø®Ø± Ø®Ø·Ø£</label>
    <div class="mono" id="err" style="background:#fff; border:1px solid #eee; padding:10px; border-radius:8px; min-height:40px"></div>
  </div>
</div>

<script>
async function start(){
  const fd = new FormData(document.getElementById('f'));
  const body = Object.fromEntries(fd.entries());
  const r = await fetch('/start', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
  const j = await r.json();
  alert(j.message || 'OK');
  refresh();
}
async function stop(){
  const r = await fetch('/stop', {method:'POST'});
  const j = await r.json();
  alert(j.message || 'OK');
  refresh();
}
async function resume(){
  const fd = new FormData(document.getElementById('f'));
  const body = Object.fromEntries(fd.entries());
  const r = await fetch('/resume', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
  const j = await r.json();
  alert(j.message || 'OK');
  refresh();
}
async function refresh(){
  const r = await fetch('/status');
  const s = await r.json();
  document.getElementById('st').textContent = s.status + (s.running?' (Running)':'');
  document.getElementById('total').textContent = s.stats?.total ?? 0;
  document.getElementById('ok').textContent = s.stats?.ok ?? 0;
  document.getElementById('fail').textContent = s.stats?.fail ?? 0;
  document.getElementById('rem').textContent = s.remaining ?? 0;
  document.getElementById('curr').textContent = s.current_did || 'â€”';
  document.getElementById('err').textContent = s.last_error || s.last_error_saved || '';
  document.getElementById('datadir').textContent = 'Ø§Ù„ØªØ®Ø²ÙŠÙ†: ' + (s.data_dir || '');
}
refresh();
</script>
</body>
</html>
"""

@app.get("/")
def index():
    return render_template_string(HTML)

@app.post("/start")
def api_start():
    data = request.get_json(force=True)
    ok, msg = start_task(
        handle=data.get("handle","").strip(),
        password=data.get("password","").strip(),
        post_url=data.get("post_url","").strip(),
        mode=(data.get("mode") or "likers").strip(),
        min_delay=int(data.get("min_delay") or 200),
        max_delay=int(data.get("max_delay") or 250),
        messages_text=data.get("messages",""),
    )
    return jsonify({"ok": ok, "message": msg})

@app.post("/stop")
def api_stop():
    ok, msg = stop_task()
    return jsonify({"ok": ok, "message": msg})

@app.post("/resume")
def api_resume():
    data = request.get_json(force=True)
    ok, msg = resume_task(
        handle=data.get("handle","").strip(),
        password=data.get("password","").strip(),
        post_url=data.get("post_url","").strip(),
        mode=(data.get("mode") or "likers").strip(),
        min_delay=int(data.get("min_delay") or 200),
        max_delay=int(data.get("max_delay") or 250),
        messages_text=data.get("messages",""),
    )
    return jsonify({"ok": ok, "message": msg})

@app.get("/status")
def api_status():
    return jsonify(read_status())


# Ù„Ù„Ù€ Render/Gunicorn
app = app
